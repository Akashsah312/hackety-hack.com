<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>hackety.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="hackety.html">hackety.rb</a>
          <a class="source" href="helpers.html">helpers.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>hackety.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <p> encoding: utf-8</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <p> This is the source code for the <a href="http://hackety-hack.com">Hackety Hack website</a>. Hackety Hack is
 the easiest way to learn programming, and so our documentation should be
 top-notch.</p>

<p> To get started, you&rsquo;ll need to install some prerequisite software:</p>

<p> <strong>Ruby</strong> is used to power the site. We&rsquo;re currently using ruby 1.9.2p0. I
 highly reccomend that you use <a href="http://rvm.beginrescueend.com/">rvm</a> to install and manage your Rubies.
 It&rsquo;s a fantastic tool. If you do decide to use <code>rvm</code>, you can install the
 appropriate Ruby and create a gemset by simply <code>cd</code>-ing into the root project
 directory; I have a magical <code>.rvmrc</code> file that&rsquo;ll set you up.</p>

<p> <strong>MongoDB</strong> is a really awesome document store. We use it to persist all of
 the data on the website. To get MongoDB, please visit their
 <a href="http://www.mongodb.org/downloads">downloads page</a> to find a package for your
 system.</p>

<p> After installing Ruby and MongoDB, you need to aquire all of the Ruby gems
 that we use. This is pretty easy, since we&rsquo;re using <strong>bundler</strong>. Just do
 this:</p>

<pre><code> $ gem install bundler
 $ bundle install
</code></pre>

<p> That&rsquo;ll set it all up! Then, you need to make sure you&rsquo;re running MongoDB.
 I have to open up another tab in my terminal and type</p>

<pre><code> $ mongod
</code></pre>

<p> to get this to happen. When you&rsquo;re done hacking, you can hit ^-c to stop
 <code>mongod</code> from running.</p>

<p> To actually start up the site, just</p>

<pre><code> $ rackup
</code></pre>

<p> and then visit <a href="http://localhost:9292">http://localhost:9292/</a>. You&rsquo;re good
 to go!</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        <h3>About hackety.rb</h3>

<p> This file is the main entry point to the application. It has three main
 purposes:</p>

<ol>
<li>Include all relevant gems and library code.</li>
<li>Configure all settings based on our environment.</li>
<li>Set up a few basic routes.</li>
</ol>


<p> Everything else is handled by code that&rsquo;s included from this file.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <h3>Including gems</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p> We need to require rubygems and bundler to get things going. Then we call
 <code>Bundler.setup</code> to get all of the magic started.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;bundler&#39;</span>
<span class="no">Bundler</span><span class="o">.</span><span class="n">setup</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p> We use <a href="http://sinatrarb.com/">sinatra</a> for our web framework. Sinatra is
 very light and simple. Good stuff.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;sinatra&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p> <a href="https://github.com/adamwiggins/pony">Pony</a> is used to send emails, just like the Pony express. Also, running <code>gem install pony</code> is really satisfying.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;pony&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <p> <a href="http://haml-lang.com/">haml</a> creates all of our templates. haml is concise
 and expressive. I really enjoy it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;haml&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        <p> <a href="http://mongomapper.com/">MongoMapper</a> is a library we use to make it easy to
 store our model classes into MongoDB.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;mongo_mapper&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        <p> If you&rsquo;ve used Rails' flash messages, you know how convenient they are.
 rack-flash lets us use them.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;rack-flash&#39;</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Flash</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        <p> <a href="https://github.com/rtomayko/rdiscount">rdiscount</a> is a fast implementation
 of the Markdown markup language. The web site renders most user submitted
 comment with Markdown.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;rdiscount&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
        <p> Rails has a <code>content_for</code> helper that lets you place different parts of your
 view into different places in your template. This helps a lot with
 javascript, and conditional stylesheets or other includes. It&rsquo;s so nice that
 foca has written
 <a href="https://github.com/foca/sinatra-content-for">a Sinatra version</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;sinatra/content_for&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
        <p> We moved lots of helpers into a separate file. These are all things that are
 useful throughout the rest of the application. This file</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">require_relative</span> <span class="s1">&#39;helpers&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
        <h3>Configure settings</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-15">#</a>
        </div>
        <p> We need a secret for our sessions. This is set via an environment variable so
 that we don&rsquo;t have to give it away in the source code. Heroku makes it really
 easy to keep environment variables set up, so this ends up being pretty nice.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Cookie</span><span class="p">,</span> <span class="ss">:secret</span> <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;COOKIE_SECRET&#39;</span><span class="o">]</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-16">#</a>
        </div>
        <p> We use <a href="http://www.getexceptional.com/">Exceptional</a> to keep track of errors
 that happen. This code is from their
 <a href="http://docs.getexceptional.com/getting-started/sinatra/">example documentation</a>
 for Sinatra. It <em>might</em> be better off inside of a config block, but I haven&rsquo;t
 tested it in that role yet.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">if</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RACK_ENV&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span>
  <span class="n">set</span> <span class="ss">:raise_errors</span><span class="p">,</span> <span class="kp">true</span>

  <span class="nb">require</span> <span class="s1">&#39;exceptional&#39;</span>
  <span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Exceptional</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;EXCEPTIONAL_API_KEY&#39;</span><span class="o">]</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-17">#</a>
        </div>
        <p> This makes <a href="http://haml-lang.com/docs/yardoc/file.HAML_REFERENCE.html#options">Haml escape any html</a> by default.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">set</span> <span class="ss">:haml</span><span class="p">,</span> <span class="ss">:escape_html</span> <span class="o">=&gt;</span> <span class="kp">true</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-18">#</a>
        </div>
        <p> The <code>PONY_VIA_OPTIONS</code> hash is used to configure <code>pony</code>. Basically, we only
 want to actually send mail if we&rsquo;re in the production environment. So we set
 the hash to just be <code>{}</code>, except when we want to send mail.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">configure</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="no">PONY_VIA_OPTIONS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">end</span>

<span class="n">configure</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="no">PONY_VIA_OPTIONS</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-19">#</a>
        </div>
        <p> We&rsquo;re using <a href="http://sendgrid.com/">SendGrid</a> to send our emails. It&rsquo;s really
 easy; the Heroku addon sets us up with environment variables with all of the
 configuration options that we need.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">configure</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="no">PONY_VIA_OPTIONS</span> <span class="o">=</span>  <span class="p">{</span>
    <span class="ss">:address</span>        <span class="o">=&gt;</span> <span class="s2">&quot;smtp.sendgrid.net&quot;</span><span class="p">,</span>
    <span class="ss">:port</span>           <span class="o">=&gt;</span> <span class="s2">&quot;25&quot;</span><span class="p">,</span>
    <span class="ss">:authentication</span> <span class="o">=&gt;</span> <span class="ss">:plain</span><span class="p">,</span>
    <span class="ss">:user_name</span>      <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;SENDGRID_USERNAME&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="ss">:password</span>       <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;SENDGRID_PASSWORD&#39;</span><span class="o">]</span><span class="p">,</span>
    <span class="ss">:domain</span>         <span class="o">=&gt;</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;SENDGRID_DOMAIN&#39;</span><span class="o">]</span>
  <span class="p">}</span>
  
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-20">#</a>
        </div>
        <p> We don&rsquo;t want to bother with running our own MongoDB server in production;
 that&rsquo;s what The Cloud &trade; is for! So we want to double check our environment
 variables, and if it appears that we&rsquo;d like to connect to
 <a href="https://mongohq.com/">MongoHQ</a>, let&rsquo;s do that. Otherwise, just connect to
 our local server running on localhost.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">configure</span> <span class="k">do</span>
  <span class="k">if</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MONGOHQ_URL&#39;</span><span class="o">]</span>
    <span class="no">MongoMapper</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MONGOHQ_HOST&#39;</span><span class="o">]</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MONGOHQ_PORT&#39;</span><span class="o">]</span><span class="p">)</span>
    <span class="no">MongoMapper</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MONGOHQ_DATABASE&#39;</span><span class="o">]</span>
    <span class="no">MongoMapper</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MONGOHQ_USER&#39;</span><span class="o">]</span><span class="p">,</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MONGOHQ_PASSWORD&#39;</span><span class="o">]</span><span class="p">)</span>
    
    <span class="no">MongoMapper</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MONGOHQ_DATABASE&#39;</span><span class="o">]</span>
  <span class="k">else</span>
    <span class="no">MongoMapper</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">)</span>
    <span class="no">MongoMapper</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="s2">&quot;hackety-development&quot;</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-21">#</a>
        </div>
        <p> Since Sinatra doesn&rsquo;t automatically load anything, we have to do it
 ourselves. Remember that helpers.rb file? Well, we made a handy
 <code>require_directory</code> method that, well, <code>require</code>s a whole directory. So let&rsquo;s
 include both of our models as well as our controllers.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">require_directory</span> <span class="s2">&quot;models&quot;</span>
<span class="n">require_directory</span> <span class="s2">&quot;controllers&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-22">#</a>
        </div>
        <h3>Set up basic routes</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-23">#</a>
        </div>
        <p> The first thing you&rsquo;ll ever see when going to the website is here. It all
 starts with <code>/</code>. If we&rsquo;re logged in, we want to just redirect to the main
 activity stream. If not, let&rsquo;s show that pretty splash page that sings all of
 our praises.</p>

<p> One small note about rendering, though: Our main layout doesn&rsquo;t exactly work
 for the main page, it&rsquo;s an exception. So we don&rsquo;t want to use our regular old
 <code>layout.haml</code> file. So we tell Sinatra not to.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">get</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
  <span class="k">if</span> <span class="n">logged_in?</span>
    <span class="n">redirect</span> <span class="s2">&quot;/stream&quot;</span>
  <span class="k">end</span>
  <span class="n">haml</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="ss">:plain</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-24">#</a>
        </div>
        <p> Hopefully, anyone visiting the site will think that Hackety Hack sounds
 pretty cool. If they do, they&rsquo;ll visit the downloads page. This&rsquo;ll direct
 them to download Hackety, and sign up for an account.</p>

<p> Similar to the home page, we also don&rsquo;t want our layout here, either.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">get</span> <span class="s1">&#39;/download&#39;</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:download</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="ss">:plain</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-25">#</a>
        </div>
        <p> The main activity stream is the main page for the site when a user is logged
 in. It lets them share what they&rsquo;re doing with others, and also view all of
 the content that others have posted. So we grab it all, and sort it in the
 opposite order that it&rsquo;s been updated. Wouldn&rsquo;t want to see old stuff!</p>

      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">get</span> <span class="s1">&#39;/stream&#39;</span> <span class="k">do</span>
  <span class="vi">@content_list</span> <span class="o">=</span> <span class="no">Content</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">sort</span><span class="p">{</span><span class="o">|</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">|</span> <span class="n">b</span><span class="o">.</span><span class="n">updated_at</span> <span class="o">&lt;=&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">updated_at</span> <span class="p">}</span>
  <span class="n">haml</span> <span class="ss">:stream</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
